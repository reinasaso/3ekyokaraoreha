<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>公演 予約サイト</title>
</head>
<body>
  <h3>千葉県立千葉高等学校3年E組</h3>
  <h1>今日から俺は!!</h1>
  <h2>公演 予約サイト</h2>

  <!-- 予約フォーム -->
  <form id="reserveForm">
    <label>名前（ニックネーム）: <input type="text" id="name" required></label><br>
    <label>公演回:
      <select id="showtime">
        <option value="09:40">09:40公演</option>
        <option value="11:00">11:00公演</option>
        <option value="12:20">12:20公演</option>
        <option value="13:40">13:40公演</option>
      </select>
    </label><br>
    <label>人数: <input type="number" id="numSeats" value="1" min="1" max="10" required></label><br>
    <button type="submit">予約する</button>
  </form>
  <p id="message"></p>

  <!-- キャンセルフォーム -->
  <h2>キャンセル</h2>
  <form id="cancelForm">
    <label>名前: <input type="text" id="cancelName" required></label><br>
    <label>公演回:
      <select id="cancelShowtime">
        <option value="09:40">09:40公演</option>
        <option value="11:00">11:00公演</option>
        <option value="12:20">12:20公演</option>
        <option value="13:40">13:40公演</option>
      </select>
    </label><br>
    <button type="submit">キャンセル</button>
  </form>
  <p id="cancelMessage"></p>

  <!-- 予約状況 -->
  <h2>予約状況</h2>
  <ul id="statusList"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBglB9eAPrGrzhbaj-6fcEy0yqok_Qz3zQ",
        authDomain: "schoolfestival-2d778.firebaseapp.com",
        databaseURL: "https://schoolfestival-2d778-default-rtdb.firebaseio.com",
        projectId: "schoolfestival-2d778",
        storageBucket: "schoolfestival-2d778.appspot.com",
        messagingSenderId: "873567089206",
        appId: "1:873567089206:web:5b922dc662cd8f99431e97",
        measurementId: "G-HHZERDLHXQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const defaultSeats = {
      "09:40": 40,
      "11:00": 40,
      "12:20": 40,
      "13:40": 40,
    };

    const seatRef = ref(db, "shows/" + showtime);
    get(seatRef).then((snap) => {
      if (!snap.exists()) set(seatRef, { seats: defaultSeats });
    });

    document.getElementById("reserveForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const showtime = document.getElementById("showtime").value;
      const numSeats = parseInt(document.getElementById("numSeats").value);
      const reservationsRef = ref(db, "reservations_" + showtime);
      const snapshot = await get(reservationsRef);

      let duplicate = false;
      if (snapshot.exists()) {
        snapshot.forEach((child) => {
          const data = child.val();
          if (data.name === name && data.showtime === showtime) {
            duplicate = true;
          }
        });
      }
      if (duplicate) {
        document.getElementById("message").textContent =
          "この名前はすでにこの公演で予約されています。";
        return;
      }

      const seatRef = ref(db, "shows/" + showtime);
      const seatSnap = await get(seatRef);
      let seats = seatSnap.exists() ? seatSnap.val().seats : defaultSeats[showtime];

      if (seats >= numSeats) {
        await set(seatRef, { seats: seats - numSeats });
        await push(reservationsRef, { name, showtime, seats: numSeats });
        document.getElementById("message").textContent =
          `予約を完了しました！`;
      } else {
        document.getElementById("message").textContent = "残席がありません";
      }
    });

    document.getElementById("cancelForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const cancelName = document.getElementById("cancelName").value;
      const cancelShowtime = document.getElementById("cancelShowtime").value;
      const reservationsRef = ref(db, "reservations_" + showtime);
      const snapshot = await get(reservationsRef);

      if (snapshot.exists()) {
        let foundKey = null;
        let cancelSeats = 0;
        snapshot.forEach((child) => {
          const data = child.val();
          if (data.name === cancelName && data.showtime === cancelShowtime) {
            foundKey = child.key;
            cancelSeats = data.seats || 1;
          }
        });

        if (foundKey) {
          const seatRef = ref(db, "shows/" + cancelShowtime);
          const seatSnap = await get(seatRef);
          let seats = seatSnap.exists() ? seatSnap.val().seats : 0;
          await set(seatRef, { seats: seats + cancelSeats });
          await remove(ref(db, "reservations_" + showtime + "/" + foundKey));
          document.getElementById("cancelMessage").textContent =
            "キャンセル完了しました！";
        } else {
          document.getElementById("cancelMessage").textContent =
            "該当する予約が見つかりません。";
        }
      }
    });

    const statusList = document.getElementById("statusList");
    for (let t in defaultSeats) {
      const seatRef = ref(db, "shows/" + t);
    onValue(seatRef, (snap) => {
      const seats = snap.exists() ? snap.val().seats : defaultSeats;
      const li = document.getElementById("status-" + t) || document.createElement("li");
        li.id = "status-" + t;
        li.textContent = `${t} 公演：残席 ${seats}`;
        if (!document.getElementById("status-" + t)) 
      statusList.innerHTML = `<li>${showtime} 公演：残席 ${seats}`;
        if (!document.getElementById("status-" + t)) statusList.appendChild(li);
    });
    }
  </script>
</body>
</html>
