<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>公演 予約サイト</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h3>千葉県立千葉高等学校3年E組</h3>
  <h1>今日から俺は!!</h1>
  <h2>公演 予約サイト</h2>
  <h3>※諸注意※</h3>
  <label>ご来場は各公演開始時間の10分前にお願いいたします。<br>
  ご予約後に公演へのご来場を取りやめられる場合は、必ずキャンセルのお手続きをお願いいたします。<br>
  残席が20以下の場合、立ち見でのご案内となります。ご了承ください。</label>

  <!-- 予約フォーム -->
  <form id="reserveForm">
    <label>名前（ニックネーム）: <input type="text" id="name" required></label><br>
    <label>公演回:
      <select id="showtime" required>
        <option value="09:30">09:30公演</option>
        <option value="11:00">11:00公演</option>
        <option value="12:20">12:20公演</option>
        <option value="13:40">13:40公演</option>
      </select>
    </label><br>
    <label>人数: <input type="number" id="numSeats" value="1" min="1" max="5" required></label><br>
    <button type="submit">予約する</button>
  </form>
  <p id="message"></p>

  <!-- キャンセルフォーム -->
  <h2>予約キャンセル</h2>
  <form id="cancelForm">
    <label>名前: <input type="text" id="cancelName" required></label><br>
    <label>公演回:
      <select id="cancelShowtime" required>
        <option value="09:30">09:30公演</option>
        <option value="11:00">11:00公演</option>
        <option value="12:20">12:20公演</option>
        <option value="13:40">13:40公演</option>
      </select>
    </label><br>
    <button type="submit">キャンセル</button>
  </form>
  <p id="cancelMessage"></p>

  <!-- 予約状況 -->
  <h2>予約状況</h2>
  <ul id="statusList"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, remove, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBglB9eAPrGrzhbaj-6fcEy0yqok_Qz3zQ",
        authDomain: "schoolfestival-2d778.firebaseapp.com",
        databaseURL: "https://schoolfestival-2d778-default-rtdb.firebaseio.com",
        projectId: "schoolfestival-2d778",
        storageBucket: "schoolfestival-2d778.appspot.com",
        messagingSenderId: "873567089206",
        appId: "1:873567089206:web:5b922dc662cd8f99431e97",
        measurementId: "G-HHZERDLHXQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const defaultSeats = {
      "09:30": 40,
      "11:00": 37,
      "12:20": 47,
      "13:40": 39,
    };

    const showTimes = ["09:30", "11:00", "12:20", "13:40"];
    const showtimeSelect = document.getElementById("showtime");

    function parseTimeToDate(timeStr) {
      const [h, m] = timeStr.split(":").map(Number);
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
    }

    function updateShowtimeOptions() {
      showtimeSelect.innerHTML = "";
      const now = new Date();
      showTimes.forEach((t) => {
        const showDate = parseTimeToDate(t);
        const showDateMinus30 = new Date(showDate.getTime() - 30 * 60 * 1000);
        if (now >= showDateMinus30 && now < showDate) {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = `${t} 公演`;
          showtimeSelect.appendChild(opt);
        }
       });
      if (showtimeSelect.options.length === 0) {
        const opt = document.createElement("option");
        opt.textContent = "現在選択できる公演はありません";
        opt.disabled = true;
        opt.selected = true;
        showtimeSelect.appendChild(opt);
      }
    }

    updateShowtimeOptions();
    setInterval(updateShowtimeOptions, 60 * 1000);

    for (let t in defaultSeats) {
      const seatRef = ref(db, "shows/" + t);
      get(seatRef).then((snap) => {
        if (!snap.exists()) {
          set(seatRef, {
            seats: defaultSeats[t],
            reservations: {}
          });
        }
      });
    }

    const statusList = document.getElementById("statusList");
    onValue(ref(db, "shows"), (snapshot) => {
      statusList.innerHTML = ""; 
      snapshot.forEach((childSnap) => {
        const time = childSnap.key;
        const data = childSnap.val();
        const li = document.createElement("li");
        li.textContent = `${time} 公演:残席 ${data.seats}`;
        statusList.appendChild(li);
      });
    });

    document.getElementById("reserveForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const showtime = document.getElementById("showtime").value;
      const numSeats = parseInt(document.getElementById("numSeats").value);
      const nameRaw = document.getElementById("name").value.trim();
      const name = nameRaw.trim().toLowerCase().replace(/[.#$\[\]/]/g, "_");
      if(!defaultSeats.hasOwnProperty(showtime)) {
        document.getElementById("message").textContent = "現在選択できる公演がありません。";
        return;
      }
      if (!name || numSeats < 1) return;

      const showRef = ref(db, `shows/${showtime}`);
      let success = false;

      await runTransaction(showRef, (current) => {
        if (current == null) current = { seats: defaultSeats[showtime],reservations: {} };
        if (!current.reservations) current.reservations = {};

        if (current.reservations[name]) {
          return;
        }
        if (current.seats < numSeats) {
          return;
        }
        current.seats -= numSeats;
        current.reservations[name] = { seats: numSeats, createdAt: Date.now() };
        return current;
      }).then((result) => {
        if (result.committed) {
            success = true;
        } else {
          document.getElementById("message").textContent =
            "残席がありません";
      }
    });

    if (success) {
      localStorage.setItem("reservedName", nameRaw);
      localStorage.setItem("reservedShowtime", showtime);
      localStorage.setItem("reservedSeats", String(numSeats));
      window.location.href = "success.html";
    }
  });

    document.getElementById("cancelForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const cancelShowtime = document.getElementById("cancelShowtime").value;
      const cancelNameRaw = document.getElementById("cancelName").value.trim();
      const cancelName = cancelNameRaw.trim().toLowerCase().replace(/[.#$\[\]/]/g, "_");
      const showRef = ref(db, `shows/${cancelShowtime}`);
        
      await runTransaction(showRef, (current) => {
        if (!current || !current.reservations || !current.reservations[cancelName]) {
          return;
        }
        const cancelSeats = current.reservations[cancelName].seats;
        current.seats += cancelSeats;
        delete current.reservations[cancelName];
        return current;
      }).then((result) => {
        if (result.committed) {
            document.getElementById("cancelMessage").textContent = "キャンセル完了しました！";
            document.getElementById("cancelForm").reset();
          } else {
            document.getElementById("cancelMessage").textContent = "該当する予約が見つかりません。";
          }
        });
      });
  </script>
</body>
</html>
